# Исправление проблемы загрузки портфолио

## Дата исправления
04.11.2024

## Описание проблемы

На странице `/portfolio/new/` после заполнения формы и выбора фотографий появлялось модальное окно с прогресс-баром, но процесс загрузки зависал, и ничего не происходило. Также отсутствовал предварительный просмотр выбранных изображений.

## Причина проблемы

1. **JavaScript ожидал JSON ответ** с полем `location` для перенаправления пользователя после успешной загрузки
2. **Django view возвращал HTML** (`render()` или `redirect()`) вместо JSON при AJAX запросах
3. **Отсутствовала обработка ошибок** в JavaScript коде
4. **Не работало обновление прогресс-бара** во время загрузки файлов
5. **Отсутствовал предварительный просмотр** выбранных изображений

## Внесенные исправления

### 1. Django view (`exhibition/views.py`)

Функция `portfolio_upload` теперь:
- Проверяет наличие заголовка `X-REQUESTED-WITH: XMLHttpRequest` для определения AJAX запросов
- Возвращает **JSON ответ** при AJAX запросах с полями:
  - `status`: 'success' или 'error'
  - `location`: URL для перенаправления
  - `message`: сообщение для пользователя
  - `errors`: ошибки валидации (при наличии)
- Сохраняет обратную совместимость с обычными HTTP запросами

#### Успешная загрузка (AJAX):
```json
{
  "status": "success",
  "location": "/account",
  "message": "Портфолио успешно сохранено"
}
```

#### Ошибка валидации (AJAX):
```json
{
  "status": "error",
  "errors": {...},
  "message": "Ошибка валидации формы"
}
```

### 2. JavaScript (`src/js/project-upload.js`)

Улучшен обработчик загрузки:

#### Обработка успешного ответа:
- Парсинг JSON ответа с проверкой типа контента
- Обновление прогресс-бара до 100%
- Отображение сообщения об успехе
- Автоматическое перенаправление через 1 секунду

#### Обработка ошибок:
- Отображение сообщений об ошибках в модальном окне
- Скрытие прогресс-бара при ошибке
- Логирование ошибок в консоль
- Обработка сетевых ошибок

#### Прогресс-бар:
- Реальное отображение процента загрузки файлов
- Плавное обновление при передаче данных
- Визуальная индикация процесса

#### Предварительный просмотр изображений:
- Автоматическое отображение миниатюр выбранных фото
- Показ до 10 первых изображений
- Счетчик общего количества файлов
- Адаптивная сетка (Bootstrap grid)

### 3. HTML шаблон (`templates/upload.html`)

Исправлено модальное окно:
- Кнопка "Отмена" теперь использует `data-bs-dismiss` (Bootstrap 5)
- Изменен класс кнопки с `btn-default` на `btn-secondary`

## Новая функциональность

### Предварительный просмотр фото

При выборе файлов автоматически создается превью:
```html
<div class="files-preview-container mt-3">
  <p class="text-muted">Выбрано файлов: 5</p>
  <div class="row g-2">
    <!-- Миниатюры изображений -->
  </div>
</div>
```

Особенности:
- Отображаются только изображения (проверка `file.type.startsWith('image/')`)
- Максимум 10 превью + текст "... и еще N файлов"
- Адаптивная сетка с классами Bootstrap 5

### Улучшенная индикация прогресса

Прогресс-бар теперь показывает:
- Процент загрузки в реальном времени
- Анимированную полосу прогресса
- Текстовое сообщение о статусе

## Совместимость

- **Django**: 4.2.15
- **Python**: 3.12.6
- **Bootstrap**: 5.3.3
- **Browsers**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

## Тестирование

### Сценарии для проверки:

1. **Загрузка нового портфолио (дизайнер):**
   - Выберите фото → увидите превью
   - Заполните форму
   - Отправьте форму → увидите прогресс-бар
   - После завершения → перенаправление в аккаунт

2. **Загрузка нового портфолио (администратор):**
   - Выберите участника и выставку
   - Выберите фото → увидите превью
   - Отправьте форму → успешная загрузка

3. **Редактирование портфолио:**
   - Откройте существующее портфолио
   - Измените данные
   - Сохраните → перенаправление в аккаунт

4. **Обработка ошибок:**
   - Превышение лимита размера файлов
   - Отправка формы без обязательных полей
   - Проблемы с сетью

## Файлы изменены

1. `exhibition/views.py` - добавлена обработка AJAX запросов с JSON ответами
2. `src/js/project-upload.js` - улучшена обработка загрузки, добавлен превью
3. `templates/upload.html` - исправлена кнопка "Отмена" для Bootstrap 5
4. `static/js/project-upload.min.js` - пересобранный минифицированный файл

## Технические детали

### Определение AJAX запроса
```python
if request.headers.get('X-REQUESTED-WITH') == 'XMLHttpRequest':
    # AJAX запрос - возвращаем JSON
else:
    # Обычный запрос - возвращаем HTML
```

### XHR в JavaScript
```javascript
xhr.setRequestHeader('X-REQUESTED-WITH', 'XMLHttpRequest');
```

### Обработка прогресса загрузки
```javascript
xhr.upload.addEventListener('progress', function (e) {
    if(e.lengthComputable){
        var progress = (e.loaded/e.total)*100;
        // Обновляем UI
    }
});
```

## Примечания

- Все изменения обратно совместимы
- Старое поведение для не-AJAX запросов сохранено
- Email уведомления отключены (закомментированы в коде)
- Формат ответа соответствует стандартной практике REST API

## Дальнейшие улучшения (опционально)

1. Добавить drag & drop для загрузки файлов
2. Реализовать удаление отдельных изображений из превью
3. Добавить валидацию размера/формата файлов на клиенте
4. Показывать размер каждого файла в превью
5. Добавить возможность изменения порядка фото перед загрузкой
