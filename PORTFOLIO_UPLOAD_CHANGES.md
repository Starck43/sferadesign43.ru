# Изменения в функционале загрузки портфолио

## Дата изменений
Текущая дата

## Обзор изменений

Реализован функционал загрузки проектов в БД по адресу `http://localhost:9000/portfolio/new/` и `http://localhost:9000/portfolio/edit/<id>` с учетом различных ролей пользователей.

## Основные возможности

### Для администраторов и редакторов (is_staff)

- Доступ ко всем полям формы загрузки портфолио
- Возможность выбрать автора проекта из списка всех дизайнеров
- **Автокомплит для быстрого поиска дизайнера** - начните вводить имя, и система предложит варианты
- Выбор выставки необязателен (можно загружать вневыставочные проекты)
- Возможность выбирать категории и номинации
- Возможность редактировать портфолио любого пользователя

### Для дизайнеров (группа Exhibitors)

- Доступ только к обязательным полям:
  - Выставка (обязательно)
  - Номинации для выбранной выставки (обязательно)
  - Фотографии проекта (обязательно)
  - Название и описание
  - Обложка
- Категории скрыты, отображаются только номинации
- Могут редактировать только свои портфолио
- Загруженные проекты автоматически скрываются до модерации администратором

### Для остальных пользователей

- Страница недоступна (возвращается 403 Forbidden)

## Технические изменения

### 1. Обработка изображений (exhibition/logic.py)

Функция `image_resize` обновлена для современного Pillow (версия ≥10):

- Автоматическая конвертация всех изображений в формат WebP
- Оптимизация размера изображений (по умолчанию 1500x1024px)
- Конвертация RGBA и прозрачных изображений в RGB с белым фоном
- Сжатие с качеством 85% (настраивается через `DJANGORESIZED_DEFAULT_QUALITY`)
- Поддержка сохранения метаданных (настраивается через `DJANGORESIZED_DEFAULT_KEEP_META`)
- Использование метода `ImageOps.contain` для Pillow ≥10 и `thumbnail` для старых версий

### 2. Проверка прав доступа (exhibition/views.py)

View `portfolio_upload` обновлен с добавлением:

- Проверка прав: разрешен доступ только администраторам, редакторам (is_staff) и дизайнерам (группа Exhibitors)
- Проверка владельца при редактировании: дизайнеры могут редактировать только свои портфолио
- Возврат 403 Forbidden для пользователей без прав доступа
- Улучшенная обработка ошибок и сообщений

### 3. Форма загрузки (exhibition/forms.py)

Класс `PortfolioForm` обновлен:

- Условная логика отображения полей в зависимости от роли пользователя
- Для администраторов/редакторов:
  - Показываются все выставки (активные и прошедшие)
  - Поле выставки необязательно
  - Добавлены атрибуты для автокомплита на поле выбора автора
- Для дизайнеров:
  - Показываются только активные выставки (date_end ≥ сегодня)
  - Поле выставки обязательно
  - Поле номинации обязательно
  - Категории скрыты

### 4. Автокомплит для выбора дизайнера (templates/upload.html)

Добавлен JavaScript код для реализации автокомплита:

- Замена стандартного select на input с поиском
- Фильтрация списка дизайнеров по мере ввода (минимум 2 символа)
- Подсветка результатов при наведении
- Автоматическое закрытие списка при выборе или клике вне
- Сохранение выбранного значения в скрытом select

## Процесс обработки загруженных изображений

1. Пользователь выбирает изображения через форму
2. При загрузке каждое изображение проверяется на размер (лимит из settings.FILE_UPLOAD_MAX_MEMORY_SIZE)
3. При сохранении модели Portfolio или Image вызывается функция `image_resize`
4. Изображение конвертируется в WebP (если это не WebP)
5. Размер изменяется до максимально допустимого (с сохранением пропорций)
6. Файл оптимизируется и сохраняется

## Структура путей для загрузки

- Портфолио: `MEDIA_ROOT/uploads/<author_slug>/<exhibition_slug>/<portfolio_slug>/<filename>.webp`
- Обложка: `MEDIA_ROOT/uploads/<author_slug>/<exhibition_slug>/<portfolio_slug>/<cover>.webp`

## Настройки в settings.py

Используются следующие настройки:

- `DJANGORESIZED_DEFAULT_SIZE` - максимальный размер изображений (по умолчанию [1500, 1024])
- `DJANGORESIZED_DEFAULT_QUALITY` - качество сжатия WebP (по умолчанию 85)
- `DJANGORESIZED_DEFAULT_KEEP_META` - сохранять ли метаданные EXIF (по умолчанию False)
- `FILE_UPLOAD_MAX_MEMORY_SIZE` - максимальный размер загружаемого файла
- `MAX_UPLOAD_FILES_SIZE` - максимальный общий размер всех загружаемых файлов

## Тестирование

Рекомендуется протестировать следующие сценарии:

1. **Администратор:**
   - Загрузка нового портфолио с выбором автора через автокомплит
   - Загрузка вневыставочного портфолио (без выставки)
   - Редактирование чужого портфолио

2. **Дизайнер:**
   - Загрузка нового портфолио для активной выставки
   - Попытка редактирования чужого портфолио (должна быть заблокирована)
   - Проверка обязательности полей выставка и номинации

3. **Обычный пользователь:**
   - Попытка доступа к странице загрузки (должна вернуть 403)

4. **Обработка изображений:**
   - Загрузка изображений в различных форматах (JPG, PNG, GIF)
   - Проверка конвертации в WebP
   - Проверка уменьшения размера больших изображений
   - Загрузка изображений с прозрачностью (PNG с альфа-каналом)

## Возможные улучшения

1. Добавить AJAX загрузку с прогресс-баром
2. Добавить предпросмотр изображений перед загрузкой
3. Добавить массовое редактирование портфолио для администраторов
4. Добавить валидацию минимального размера изображений
5. Добавить автоматическое создание thumbnails разных размеров

## Известные ограничения

1. Автокомплит работает только на клиентской стороне (все опции загружаются сразу)
2. Для большого количества дизайнеров (>1000) рекомендуется использовать серверный автокомплит
3. Обработка изображений происходит синхронно и может замедлить отклик при загрузке большого количества файлов
