
// Проверка появления элемента в видимой области экрана
function isInViewport(el, onlyVisible=false, fullInView=false) {
	if (onlyVisible && (el.style.visibility == 'hidden' || el.style.display == 'none')) return false;

	const {top:t, bottom:b, height:h} = el.getBoundingClientRect();
	if (fullInView){
		return (
			t >= 0 &&
			b <= (window.innerHeight || document.documentElement.clientHeight)
		);
	} else {
		return (t <= window.innerHeight && t + h >= 0);
	}

}

// Разворачивание/сворачивание списка с выставками в меню
function toggleNavItems(link) {
	link && link.forEach( (e) => {
		if (window.innerWidth < 992) {
			( e.classList.contains('dropdown-toggle')) && e.classList.remove('hidden');
			(!e.classList.contains('dropdown-toggle')) && e.classList.add('hidden');
		} else {
			( e.classList.contains('dropdown-toggle')) && e.classList.add('hidden');
			(!e.classList.contains('dropdown-toggle')) && e.classList.remove('hidden');
		}
	});
}

// Переключение класса для Burger menu
function toggleBurgerMenu(elem) {
	if (window.innerWidth >= 992) {
		if (elem.classList.contains('navbar-expand-lg') && elem.classList.contains('burger-menu')) {
			elem.classList.remove('burger-menu')
		}
	} else {
		if (elem.classList.contains('navbar-expand-lg') && ! elem.classList.contains('burger-menu')) {
			elem.classList.add('burger-menu')
		}
	}
}

// Вычисление высоты верхнего блока навигации
function navbarOffset(elem) {
	// Добавим смещение следущему после меню элементу
	elem.nextElementSibling.style.marginTop = elem.clientHeight + 'px';
}


document.addEventListener("DOMContentLoaded", function() {
	
		var scrollDown = document.querySelector('.scroll-down');
		var scrollUp = document.querySelector('#back2top');
	
		document.onscroll = function(e) { // закрытие окна поиска по скролу
	
			if (scrollDown && window.pageYOffset >= window.innerHeight  ) {
				scrollDown.remove();
				scrollDown = null;
			}
	
			if (scrollUp) {
				if (window.pageYOffset <= window.innerHeight) {
					if (! scrollUp.classList.contains('disable')) {
						scrollUp.classList.add('disable');
						scrollUp.style.transform = `translateY(${scrollUp.parentElement.clientHeight*2}px)`;
					}
				} else
					if (scrollUp.classList.contains('disable')) {
						scrollUp.classList.remove('disable');
						scrollUp.style.transform = `translateY(${-scrollUp.parentElement.clientHeight}px)`;
					}
			}
	
			searchContainer && searchContainer.classList.contains('active') && searchContainer.classList.remove('active');
		};
	
	
		const loadingElements = document.body.querySelectorAll('.loading');
		loadingElements.forEach( function(item) {
			item.classList.remove('loading');
			item.classList.add('loaded');
		});
	
		 // Скролинг с позиционированием элемента вверху экрана
		function smoothScroll(pos, offset=0) {
			window.scrollTo({
				top: pos - offset, //+ window.scrollY
				behavior: "smooth"
			});
		}
	
		scrollUp && scrollUp.addEventListener('click', function (e) {
			e.preventDefault();
			smoothScroll(0, 0); // скролл вверх до блока навигации
		});
	
		scrollDown && scrollDown.addEventListener('click', function (e) {
			e.preventDefault();
			smoothScroll(0, -window.innerHeight); // скролл вниз на высоту экрана
		});

	const navbar = document.querySelector('nav.navbar');
	const html = document.querySelector('html.sd43');
	html && navbarOffset(navbar);
	html && toggleBurgerMenu(navbar);

	const exhibitionsLink = document.querySelectorAll('.exh-nav-item .nav-link');
	(window.innerWidth >= 992) && toggleNavItems(exhibitionsLink);

	if ('loading' in HTMLImageElement.prototype) {
		var images = document.querySelectorAll("img");
		images.forEach(img => {
			var preserveLazyload = (img.classList.contains('image-img') && document.querySelector("html").classList.contains('desktop'));
			if (!preserveLazyload) {
				if (img.dataset.src) 	img.removeAttribute('data-src');
				if (img.dataset.srcset) img.removeAttribute('data-srcset');
				if (! img.classList.contains('lasyloaded')) img.classList.add('lazyloaded');
				img.classList.remove('lazyload');
			}
		});
	}


	//обработаем нажатие на '+/-' у заголовка групп фильтрации checkbox для развертывания/свертывания
	const collapsedBlock = document.querySelectorAll('.collapsed')
	collapsedBlock.forEach( (item) => {
		item.addEventListener('click', (e) => {

			if (e.currentTarget.classList.contains('collapsed')) {
				e.currentTarget.classList.remove('collapsed');
				e.currentTarget.classList.add('expanded');
			} else
			if (e.currentTarget.classList.contains('expanded')) {
				e.currentTarget.classList.remove('expanded');
				e.currentTarget.classList.add('collapsed');
			}
		}, {passive: true});
	});



	// Обработчик нажатия на кнопу поиска
	const searchContainer = document.querySelector('#searchContainer');
	const searchInput = searchContainer.querySelector('[type=search]');
	const clearInput = searchContainer.querySelector('.clear-input');
	const searchLink = document.querySelectorAll('.nav-search-link');
	searchLink.forEach( (item) => {
		item.addEventListener('click', (e) => {
			e.preventDefault();

			searchContainer.classList.toggle('active');
			if (searchContainer.classList.contains('active')) {
				if (searchInput.value) {
					clearInput.classList.add('show');
				}
				searchInput.focus();
			} else
				searchInput.blur();
		});
	});

	// Обработчик очистки содержимого поля для текста
	clearInput.addEventListener('click', (e) => {
		searchInput.value = '';
		searchInput.focus();
		e.target.classList.remove('show');
	});
	// Обработчик нажатия на строку поиска в меню
	searchInput.addEventListener('input', (e) => {
		var input = this.activeElement;
		if (input.textLength > 0 && ! clearInput.classList.contains('show')) {
			clearInput.classList.add('show');
		}
		if (input.textLength == 0 &&  clearInput.classList.contains('show')) {
			clearInput.classList.remove('show');
		}
	});

	const menu = document.querySelector('#navbarNavDropdown');
	var menuCanvas = (menu) ? new bootstrap.Offcanvas(menu) : null;

	const sidebar = document.querySelector('#sidebarPrimary');
	var sidebarCanvas = (sidebar) ? new bootstrap.Offcanvas(sidebar) : null;

	// закрытие модальных окон при изменении размера окна
	window.addEventListener('resize', function(){
		html && navbarOffset(navbar);
		html && toggleBurgerMenu(navbar);
		toggleNavItems(exhibitionsLink);
		if (window.innerWidth >= 992) {
			if (menuCanvas && menu.classList.contains('show') ) {
				menuCanvas.hide();
			}
			if (sidebarCanvas && sidebar.classList.contains('show')) {
				sidebarCanvas.hide();
			}
		}
	});

	document.onkeydown = function(e) { // закрытие окна поиска по клавише escape
		e = e || window.event;
		(e.keyCode == 27) && searchContainer.classList.remove('active');
	};


});