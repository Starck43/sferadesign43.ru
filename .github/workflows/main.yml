name: sd43 CI/CD

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  DOMAIN_NAME: 'sd43.ru'
  PROJECT_NAME: 'sd43'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
            echo "âœ… npm dependencies installed"
          else
            echo "âš ï¸  No package.json found, skipping npm install"
          fi

      - name: Build assets
        run: |
          if [ -f "package.json" ]; then
            echo "ðŸ“¦ Building assets..."
            npm run build
          
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐ±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÑˆÐ»Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
            if [ -d "static/js" ] || [ -d "static/css" ]; then
              echo "âœ… Assets built successfully"
              find static/ -type f -name "*.js" -o -name "*.css" | head -10
            else
              echo "âš ï¸  No js/css directories found after build"
            fi
          else
            echo "â­ï¸  Skipping build - no package.json"
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH host to known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ vars.SSH_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Create rsync exclude file
        run: |
          cat > .deploy/rsync_exclude.txt << 'EOF'
          .git/
          .github/
          .env
          *.env
          venv/
          resources/
          media/*
          !media/site/
          static/
          !static/fonts/
          !static/favicons/
          EOF
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ
          find . -path "*/migrations/*.py" -not -name "__init__.py" 2>/dev/null | head -5 >> .deploy/rsync_exclude.txt || true
          find . -path "*/migrations/*.pyc" 2>/dev/null | head -5 >> .deploy/rsync_exclude.txt || true

      - name: Prepare deployment structure
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"

          echo "ðŸš€ Preparing deployment to $REMOTE_DIR"

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ñ€Ð½ÐµÐ²ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          ssh "$REMOTE_USER@$REMOTE_HOST" "
            mkdir -p '$REMOTE_DIR'
            chown -R starck:starck '$REMOTE_DIR' 2>/dev/null || true
          "

      - name: Create .env file from secret
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð°
          cat > /tmp/.env << 'EOF'
          ${{ secrets.PROD_ENV_FILE }}
          EOF

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
          scp /tmp/.env "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/.env"

          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°
          ssh "$REMOTE_USER@$REMOTE_HOST" "chmod 600 '$REMOTE_DIR/.env' && chown starck:starck '$REMOTE_DIR/.env'"

          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ
          rm -f /tmp/.env

          echo "âœ… .env file deployed"

      - name: Sync files to server
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"
          
          echo "ðŸ“¤ Syncing files to server..."
          
          # ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ
          rsync -avz \
            --delete \
            --exclude-from=.deploy/rsync_exclude.txt \
            --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r \
            ./ \
            "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/"
          
          # ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ð¾ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ site ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÐµÑÑ‚ÑŒ
          if [ -d "./media/site" ]; then
            echo "ðŸ“ Syncing media/site directory..."
            rsync -avz \
              ./media/site/ \
              "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/media/site/"
          fi
          
          echo "âœ… Files synced successfully"

      - name: Run deployment script
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          REMOTE_DIR="/home/starck/domains/${{ env.DOMAIN_NAME }}"
          
          echo "ðŸ”„ Running deployment script..."
          
          ssh "$REMOTE_USER@$REMOTE_HOST" "
            set -e
            cd '$REMOTE_DIR'
          
            # Ð”ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
            chmod +x .deploy/deployment_script.sh 2>/dev/null || true
          
            # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹
            bash .deploy/deployment_script.sh \
              '${{ env.PROJECT_NAME }}' \
              '$REMOTE_DIR' \
              '${{ vars.DJANGO_ADMIN_EMAIL }}' \
              '${{ vars.DJANGO_ADMIN_SUPERUSER }}' \
              '${{ secrets.DJANGO_ADMIN_PASSWORD }}'
          "
          
          echo "âœ… Deployment script executed"

      - name: Verify deployment
        run: |
          REMOTE_USER="${{ vars.SSH_USER }}"
          REMOTE_HOST="${{ vars.SSH_HOST }}"
          
          echo "ðŸ” Verifying deployment..."
          
          ssh "$REMOTE_USER@$REMOTE_HOST" "
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
            if systemctl is-active --quiet sd43.service; then
              echo 'âœ… Service sd43.service is running'
          
              # Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
              systemctl status sd43.service --no-pager | head -10
            else
              echo 'âŒ Service sd43.service is not running!'
              systemctl status sd43.service --no-pager
              exit 1
            fi
          
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾ÐºÐµÑ‚
            if [ -S '/run/gunicorn.sd43.sock' ]; then
              echo 'âœ… Socket /run/gunicorn.sd43.sock exists'
              ls -la /run/gunicorn.sd43.sock
            else
              echo 'âš ï¸  Socket not found, checking service...'
            fi
          
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³
            if sudo nginx -t 2>/dev/null; then
              echo 'âœ… Nginx configuration is valid'
            fi
          "
          
          echo "ðŸŽ‰ Deployment completed successfully!"
